#################################################################
################# LOAD CONTROL PACKAGE #####################
#################################################################
# Author: andbad                                                #
# GitHub: https://github.com/andbad/HA_PowerControl             #
# Version: 3.42b                                                 #
#################################################################
########################### CREDITS #############################
# Thanks to the InDomus community for their help                #
# received in the compilation of the following package.         #
#       ----->>      https://indomus.it/      <<-----           #
#################################################################


# The following package, combined with the python script "update_entities.py" aims to avoid counter detachment due to
# of too much power absorbed by the various appliances (loads).
# Fundamental hardware requirement is the presence of switches on the loads to be controlled and a sensor that measures the power
# of individual loads.
# I personally used Shelly 1PM and Shelly Plug S devices, perfect for the purpose.
# It is recommended, but not mandatory, to use a sensor that monitors the overall consumption of the system (eg Shelly EM).
# The logic is that if the overall usage exceeds the set limit value, the package starts detachment
# of lower priority loads to higher priority loads, until overall power utilization falls within
# within the set limit.
# There are two maximum limits: in case you exceed the maximum value "delayed", the system will wait a few minutes
# (adjustable by a special option) before proceeding with the detachment; if the immediate maximum value is exceeded,
# The detachment occurs after a few seconds (also in this case adjusted by its slider).
# The script keeps memory of load absorption before detachment and reconnects it only when availability
# of power is sufficient not to cause a new detachment.
# The configuration is entirely via lovelace interface, except the notification group (notify.tutti) which must be set
# manually.

#################################################################
########################## RECORDER #############################
#################################################################
# The following sensors must be enabled in the recorder, in order to display the intervention history in the graph
# of the graphical interface. Uncommenting the following lines may affect the configuration of the recorder in other files.

#recorder:
#  include:
#    entities:
#      - sensor.selected_loads
#      - sensor.suspended_loads
#      - sensor.immediate_maximum_power
#      - sensor.delayed_maximum_power

#################################################################
########################## SENSORS ##############################
#################################################################
# The most effective solution is to use a power sensor upstream of the system, just before the meter.
# In that case just select the appropriate sensor in the configuration.
# The following example uses a ShellyEM, in channel 1.
# - Platform: MQTT
# name: "Power loads"
# state_topic: "shellies/NOME_SHELLY/emeter/0/power"
# value_template: "{{ value }}"
# unit_of_measurement : "Watt"
# icon: mdi:speedometer
template:
# Alternatively you can use the power sensors of the higher loads used and maintain a certain margin
# tolerance.
# This involves monitoring all major loads (oven, stove, hair dryer, air conditioners, etc ...).
# Of course in this way you can not evaluate the overall consumption, so you could exceed the limit value
# without load control intervening.
# Using a conservative maximum power value (e.g. 3kW) and counting on the tolerances of 180 minutes up to 80%
# (e.g. 3.6kW) is equally functional.
  - sensor:
    - name: virtual_power_load
      unit_of_measurement: 'W'
      state: >
          {{ states(states('input_text.power_load_1'))|int(default=0) +
             states(states('input_text.power_load_2'))|int(default=0) +
             states(states('input_text.power_load_3'))|int(default=0) +
             states(states('input_text.power_load_4'))|int(default=0) +
             states(states('input_text.power_load_5'))|int(default=0) +
             states(states('input_text.power_load_6'))|int(default=0) +
             states(states('input_text.power_load_7'))|int(default=0) +
             states(states('input_text.power_load_8'))|int(default=0) +
             states(states('input_text.power_load_9'))|int(default=0) +
             states(states('input_text.power_load_10'))|int(default=0) +
             states(states('input_text.power_load_11'))|int(default=0) +
             states(states('input_text.power_load_12'))|int(default=0) +
             states(states('input_text.power_load_13'))|int(default=0) +
             states(states('input_text.power_load_14'))|int(default=0) +
             states(states('input_text.power_load_15'))|int(default=0) +
             states(states('input_text.power_load_16'))|int(default=0) +
             states(states('input_text.power_load_17'))|int(default=0) +
             states(states('input_text.power_load_18'))|int(default=0) +
             states(states('input_text.power_load_19'))|int(default=0) +
             states(states('input_text.power_load_20'))|int(default=0) }}

# Sum of all "suspended" power, i.e. loads that were in operation with a given absorption but were
# disabled.
    - name: suspended_load
      unit_of_measurement: 'W'
      state: >
          {{ states('input_number.suspended_load_1')|int(default=0) + 
             states('input_number.suspended_load_2')|int(default=0) + 
             states('input_number.suspended_load_3')|int(default=0) + 
             states('input_number.suspended_load_4')|int(default=0) + 
             states('input_number.suspended_load_5')|int(default=0) + 
             states('input_number.suspended_load_6')|int(default=0) + 
             states('input_number.suspended_load_7')|int(default=0) + 
             states('input_number.suspended_load_8')|int(default=0) + 
             states('input_number.suspended_load_9')|int(default=0) + 
             states('input_number.suspended_load_10')|int(default=0) +
             states('input_number.suspended_load_11')|int(default=0) + 
             states('input_number.suspended_load_12')|int(default=0) + 
             states('input_number.suspended_load_13')|int(default=0) + 
             states('input_number.suspended_load_14')|int(default=0) + 
             states('input_number.suspended_load_15')|int(default=0) + 
             states('input_number.suspended_load_16')|int(default=0) + 
             states('input_number.suspended_load_17')|int(default=0) + 
             states('input_number.suspended_load_18')|int(default=0) + 
             states('input_number.suspended_load_19')|int(default=0) + 
             states('input_number.suspended_load_20')|int(default=0) }}

# Shows the status of the selected sensor, useful for the graph.
    - name: selected_power_load
      unit_of_measurement: 'W'
      state: "{{ states(states('input_text.power_load')) |int(default=0) }}"

# Maximum value that loads can reach before starting the detachment
    - name: immediate_maximum_power
      unit_of_measurement: 'W'
      state: "{{ states('input_number.immediate_maximum_power')|int(default=0) }}"

    - name: delayed_maximum_power
      unit_of_measurement: 'W'
      state: "{{ states('input_number.delayed_maximum_power')|int(default=0) }}"
        
#################################################################
######################### INPUT_* ###############################
#################################################################
input_text:
# In these fields, the name of the entities selected by the front end is saved.
  power_load_1:
  power_load_2:
  power_load_3:
  power_load_4:
  power_load_5:
  power_load_6:
  power_load_7:
  power_load_8:
  power_load_9:
  power_load_10:
  power_load_11:
  power_load_12:
  power_load_13:
  power_load_14:
  power_load_15:
  power_load_16:
  power_load_17:
  power_load_18:
  power_load_19:
  power_load_20:

  load_1_switch:
  load_2_switch:
  load_3_switch:
  load_4_switch:
  load_5_switch:
  load_6_switch:
  load_7_switch:
  load_8_switch:
  load_9_switch:
  load_10_switch:
  load_11_switch:
  load_12_switch:
  load_13_switch:
  load_14_switch:
  load_15_switch:
  load_16_switch:
  load_17_switch:
  load_18_switch:
  load_19_switch:
  load_20_switch:

  power_load:

input_boolean:
# Switch for the graphical interface
  active_power_control:
    name: Active Power Control
    icon: mdi:car-cruise-control

  power_control_settings:
    name: Show Power Control Settings
    icon: mdi:car-cruise-control

# Tracks the trigger that triggered the stop automation:
# if it is "0" means that the threshold of delayed posting has been exceeded
# if it is "1" the threshold of immediate detachment has been exceeded.
  trigger_sensor:
    name: trigger sensor
    initial: off
    
# If set on, activate the new script that filters only entities starting with "sensor.power" and "switch.switch"
  selection_python_script:
    name: Selection Python Script

    
input_number:

# They keep memory of the power used at the time of detachment, to evaluate reactivation.
  suspended_load_1:
    initial: 0
    min: 0
    max: 15000
  suspended_load_2:
    initial: 0
    min: 0
    max: 15000
  suspended_load_3:
    initial: 0
    min: 0
    max: 15000
  suspended_load_4:
    initial: 0
    min: 0
    max: 15000
  suspended_load_5:
    initial: 0
    min: 0
    max: 15000
  suspended_load_6:
    initial: 0
    min: 0
    max: 15000
  suspended_load_7:
    initial: 0
    min: 0
    max: 15000
  suspended_load_8:
    initial: 0
    min: 0
    max: 15000
  suspended_load_9:
    initial: 0
    min: 0
    max: 15000
  suspended_load_10:
    initial: 0
    min: 0
    max: 15000
  suspended_load_11:
    initial: 0
    min: 0
    max: 15000
  suspended_load_12:
    initial: 0
    min: 0
    max: 15000
  suspended_load_13:
    initial: 0
    min: 0
    max: 15000
  suspended_load_14:
    initial: 0
    min: 0
    max: 15000
  suspended_load_15:
    initial: 0
    min: 0
    max: 15000
  suspended_load_16:
    initial: 0
    min: 0
    max: 15000
  suspended_load_17:
    initial: 0
    min: 0
    max: 15000
  suspended_load_18:
    initial: 0
    min: 0
    max: 15000
  suspended_load_19:
    initial: 0
    min: 0
    max: 15000
  suspended_load_20:
    initial: 0
    min: 0
    max: 15000
  
 # Slider for the configuration of the maximum usable power, exceeded this threshold the detachment is immediate
  immediate_maximum_power:
    min: 0
    max: 26000
    step: 100

 # Slider for the configuration of the maximum usable power, exceeding this threshold the system will wait a few minutes
 # before acting.
  delayed_maximum_power:
    min: 0
    max: 25000
    step: 100

 # Wait a few SECONDS between one detachment and the next.
  immediate_stop_pace:
    min: 0
    max: 60
    step: 1  
  
 # Wait a few MINUTES between one detachment and another.
  delayed_stop_pace:
    min: 0
    max: 180
    step: 10  
  
 # So many MINUTES after the power used has returned below the treshold, start to reactivate the loads
  restart_delay:
    min: 0
    max: 60
    step: 1  
  
 # Wait a few SECONDS between one detachment and another.
  pause_between_detachments:
    min: 0
    max: 60
    step: 1  

  # Wait a few MINUTES between one reactivation and another to give time to the load to resume its normal absorption
  pause_between_reactivations:
    min: 0
    max: 60
    step: 1  


input_select:
# Drop-down for Power Control setup. The list of switches and sensors is updated when HA starts.
  load_list:
    name: Power load List
    options:
      - Select
      
# Selection of the power sensor used. If not configured, the virtual sensor is used
  power_loads:
    name: Power load Sensor
    options:
      - Select

# Load switch
  load_1_switch:
    name: Priority Load Switch 1
    options:
      - Select
  load_2_switch:
    name: Priority Load Switch 2
    options:
      - Select
  load_3_switch:
    name: Priority Load Switch 3
    options:
      - Select
  load_4_switch:
    name: Priority Load Switch 4
    options:
      - Select
  load_5_switch:
    name: Priority Load Switch 5
    options:
      - Select
  load_6_switch:
    name: Priority Load Switch 6
    options:
      - Select
  load_7_switch:
    name: Priority Load Switch 7
    options:
      - Select
  load_8_switch:
    name: Priority Load Switch 8
    options:
      - Select
  load_9_switch:
    name: Priority Load Switch 9
    options:
      - Select
  load_10_switch:
    name: Priority Load Switch 10
    options:
      - Select
  load_11_switch:
    name: Priority Load Switch 11
    options:
      - Select
  load_12_switch:
    name: Priority Load Switch 12
    options:
      - Select
  load_13_switch:
    name: Priority Load Switch 13
    options:
      - Select
  load_14_switch:
    name: Priority Load Switch 14
    options:
      - Select
  load_15_switch:
    name: Priority Load Switch 15
    options:
      - Select
  load_16_switch:
    name: Priority Load Switch 16
    options:
      - Select
  load_17_switch:
    name: Priority Load Switch 17
    options:
      - Select
  load_18_switch:
    name: Priority Load Switch 18
    options:
      - Select
  load_19_switch:
    name: Priority Load Switch 19
    options:
      - Select
  load_20_switch:
    name: Priority Load Switch 20
    options:
      - Select

# Power load sensors
  power_load_1:
    name: Priority Load Sensor 1
    options:
      - Select
  power_load_2:
    name: Priority Load Sensor 2
    options:
      - Select
  power_load_3:
    name: Priority Load Sensor 3
    options:
      - Select
  power_load_4:
    name: Priority Load Sensor 4
    options:
      - Select
  power_load_5:
    name: Priority Load Sensor 5
    options:
      - Select
  power_load_6:
    name: Priority Load Sensor 6
    options:
      - Select
  power_load_7:
    name: Priority Load Sensor 7
    options:
      - Select
  power_load_8:
    name: Priority Load Sensor 8
    options:
      - Select
  power_load_9:
    name: Priority Load Sensor 9
    options:
      - Select
  power_load_10:
    name: Priority Load Sensor 10
    options:
      - Select
  power_load_11:
    name: Priority Load Sensor 11
    options:
      - Select
  power_load_12:
    name: Priority Load Sensor 12
    options:
      - Select
  power_load_13:
    name: Priority Load Sensor 13
    options:
      - Select
  power_load_14:
    name: Priority Load Sensor 14
    options:
      - Select
  power_load_15:
    name: Priority Load Sensor 15
    options:
      - Select
  power_load_16:
    name: Priority Load Sensor 16
    options:
      - Select
  power_load_17:
    name: Priority Load Sensor 17
    options:
      - Select
  power_load_18:
    name: Priority Load Sensor 18
    options:
      - Select
  power_load_19:
    name: Priority Load Sensor 19
    options:
      - Select
  power_load_20:
    name: Priority Load Sensor 20
    options:
      - Select

#################################################################
####################### AUTOMATION #############################
#################################################################
automation:

# When starting HA, update the input_slider with the list of entities for configuration fields.
# When HA starts, wait for the "Populate Entities" automation to finish, then load the switch configuration
# and power sensors.
  - id: 'powercontrol_load_config'
    alias: PowerControl - Load - Config
    mode: single
    trigger:
      - platform: homeassistant
        event: start
#      - platform: state
#        entity_id: input_boolean.selection_python_script
        id: start
      - platform: event
        id: reload
        event_type:
          - automation_reloaded
    action:
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Load - Launch Configuration Script"
      - choose:
          - conditions:
              - condition: trigger
                id: start
            sequence:
              - service: script.turn_on
                data: { }
                entity_id: script.powercontrol_configurazione_popola_entita
              - wait_template: "{{ state_attr('script.powercontrol_configurazione_popola_entita','current') == 0 }}"
          - conditions:
              - condition: trigger
                id: reload
            sequence:
              - delay:
                  minutes: 1
              - service: script.turn_on
                data: { }
                entity_id: script.powercontrol_configurazione_popola_entita
              - wait_template: "{{ state_attr('script.powercontrol_configurazione_popola_entita','current') == 0 }}"
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Load - End Configuration Script"

      # Automazione che si triggera nel momento in cui la la potenza utilizzata supera la potenza massima impostata.
      # Agisce dopo TOT secondi dal superamento del limite, avvia lo script di distacco ed invia notifica di intervento.
      # Ripete l'avvio dello script di distacco finché la potenza impegnata non rientra nel limite.
      # Automation that is triggered when the power used exceeds the maximum power set.
      # Acts after TOT seconds from exceeding the limit, starts the detachment script and sends intervention notification.
      # Repeats the start of the detachment script until the committed power is within the limit.
  - id: 'powercontrol_loads_stop'
    alias: PowerControl - Loads Stop
    mode: single
    description: ''
    trigger:
    - platform: template
      value_template: "{{ states(states('input_text.power_load')) |int(default=0) > states('sensor.immediate_maximum_power')|int(default=0) }}"
      for:
        seconds: "{{ states('input_number.immediate_stop_pace')|int(default=0) }}"
      id: immediato
    - platform: template
      value_template: "{{ states(states('input_text.power_load')) |int(default=0) > states('sensor.delayed_maximum_power')|int(default=0) }}"
      for:
        minutes: "{{ states('input_number.delayed_stop_pace')|int(default=0) }}"
      id: ritardato
    condition:
    - condition: state
      entity_id: input_boolean.active_power_control
      state: 'on'
    action:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Load Automation Stop Triggered: Load Power ({{ states(states('input_text.power_load'))|int(default=0) }}))"
    - choose:
      - conditions:
#          - condition: state
#            entity_id: input_boolean.selection_python_script
#            state: 'off'
          - condition: trigger
            id: immediate
        sequence:
#          - service: python_script.update_entities
          - service: input_boolean.turn_on
            target:
              entity_id: input_boolean.trigger_sensor
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Load Automation Stop Triggered: Immediate Trigger Type"
      - conditions:
#          - condition: state
#            entity_id: input_boolean.selection_python_script
#            state: 'on'
          - condition: trigger
            id: delayed
        sequence:
#          - service: python_script.update_entities_new
          - service: input_boolean.turn_off
            target:
              entity_id: input_boolean.trigger_sensor
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Load Automation Stop Triggered: Delayed Trigger Type"

    - repeat:
        sequence:
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Started load stop script: load power {{ states(states('input_text.power_load'))|int(default=0)}}"
          - service: script.turn_on
            data: {}
#            entity_id: script.stop_carichi_generale
            entity_id: script.genaral_stop_load
        until:
          - condition: template
            value_template: >
              {{
              ((states(states('input_text.power_load'))|int(default=0) > states('sensor.delayed_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "off") or
              ((states(states('input_text.power_load'))|int(default=0) > states('sensor.immediate_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "on")
              }}
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.trigger_sensor

# Se per TOT minuti il limite di potenza è rispettato, avvia lo script di riattivazione dei carichi fino a che la potenza "sospesa" non è zero.
# If the power limit is respected for TOT minutes, start the load reactivation script until the "suspended" power is zero.
  - id: 'powercontrol_load_start'
    alias: PowerControl - Load Start
    description: ''
    mode: single
    trigger:
    - platform: template
      value_template: "{{ ((states(states('input_text.power_load'))|int(default=0) + states('sensor.suspended_loads')|int(default=0)) < states('sensor.delayed_maximum_power')|int(default=0)) and (states('sensor.suspended_loads')|int(default=0) > 0) }}"
      for:
        minutes: "{{ states('input_number.start_time')|int(default=0) }}"
    condition:
    - condition: state
      entity_id: input_boolean.active_power_control
      state: 'on'
    - condition: template
      value_template: "{{ states('sensor.suspended_loads')|int(default=0) > 0 }}"
    action:

    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Configuration Automation - Populate entities - Finished python scripts"
    mode: single

# When starting HA wait for the "Populate entities" automation to finish, then load the switch configuration
# and power sensors.
  - id: 'powercontrol_loads_configuration'
    alias: PowerControl - Loads - Configuration
    trigger:
      platform: homeassistant
      event: start
    action:
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Automation Configuration - Upload - Start automation, wait for end automation powercontrol_populate_entity_configuration"
      - wait_template: "{{ state_attr('automation.powercontrol_populate_entity_configuration','current') == 0 }}"
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Loads - Load input_select by its input_text"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load
          option: "{{ states('input_text.power_load') }}"
              
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_1
          option: "{{ states('input_text.power_load_1') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_2
          option: "{{ states('input_text.power_load_2') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_3
          option: "{{ states('input_text.power_load_3') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_4
          option: "{{ states('input_text.power_load_4') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_5
          option: "{{ states('input_text.power_load_5') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_6
          option: "{{ states('input_text.power_load_6') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_7
          option: "{{ states('input_text.power_load_7') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_8
          option: "{{ states('input_text.power_load_8') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_9
          option: "{{ states('input_text.power_load_9') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_10
          option: "{{ states('input_text.power_load_10') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_11
          option: "{{ states('input_text.power_load_11') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_12
          option: "{{ states('input_text.power_load_12') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_13
          option: "{{ states('input_text.power_load_13') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_14
          option: "{{ states('input_text.power_load_14') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_15
          option: "{{ states('input_text.power_load_15') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_16
          option: "{{ states('input_text.power_load_16') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_17
          option: "{{ states('input_text.power_load_17') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_18
          option: "{{ states('input_text.power_load_18') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_19
          option: "{{ states('input_text.power_load_19') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.power_load_20
          option: "{{ states('input_text.power_load_20') }}"
          

      - service: input_select.select_option
        data:
          entity_id: input_select.load_1_switch
          option: "{{ states('input_text.load_1_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_2_switch
          option: "{{ states('input_text.load_2_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_3_switch
          option: "{{ states('input_text.load_3_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_4_switch
          option: "{{ states('input_text.load_4_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_5_switch
          option: "{{ states('input_text.load_5_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_6_switch
          option: "{{ states('input_text.load_6_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_7_switch
          option: "{{ states('input_text.load_7_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_8_switch
          option: "{{ states('input_text.load_8_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_9_switch
          option: "{{ states('input_text.load_9_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_10_switch
          option: "{{ states('input_text.load_10_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_11_switch
          option: "{{ states('input_text.load_11_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_12_switch
          option: "{{ states('input_text.load_12_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_13_switch
          option: "{{ states('input_text.load_13_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_14_switch
          option: "{{ states('input_text.load_14_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_15_switch
          option: "{{ states('input_text.load_15_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_16_switch
          option: "{{ states('input_text.load_16_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_17_switch
          option: "{{ states('input_text.load_17_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_18_switch
          option: "{{ states('input_text.load_18_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_19_switch
          option: "{{ states('input_text.load_19_switch') }}"
      - service: input_select.select_option
        data:
          entity_id: input_select.load_20_switch
          option: "{{ states('input_text.load_20_switch') }}"

      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Upload - End of Loading"

# When a parameter is changed in PowerControl configuration via input_select,
# waits for the "Load" automation to finish, then loads the value into the relative input_text.
  - id: 'powercontrol_configuration_save'
    alias: PowerControl - Configuration - Save
    trigger:
      platform: state
      entity_id: 
        - input_select.power_load
        - input_select.power_load_1
        - input_select.power_load_2
        - input_select.power_load_3
        - input_select.power_load_4
        - input_select.power_load_5
        - input_select.power_load_6
        - input_select.power_load_7
        - input_select.power_load_8
        - input_select.power_load_9
        - input_select.power_load_10
        - input_select.power_load_11
        - input_select.power_load_12
        - input_select.power_load_13
        - input_select.power_load_14
        - input_select.power_load_15
        - input_select.power_load_16
        - input_select.power_load_17
        - input_select.power_load_18
        - input_select.power_load_19
        - input_select.power_load_20
        
        - input_select.load_1_switch
        - input_select.load_2_switch
        - input_select.load_3_switch
        - input_select.load_4_switch
        - input_select.load_5_switch
        - input_select.load_6_switch
        - input_select.load_7_switch
        - input_select.load_8_switch
        - input_select.load_9_switch
        - input_select.load_10_switch
        - input_select.load_11_switch
        - input_select.load_12_switch
        - input_select.load_13_switch
        - input_select.load_14_switch
        - input_select.load_15_switch
        - input_select.load_16_switch
        - input_select.load_17_switch
        - input_select.load_18_switch
        - input_select.load_19_switch
        - input_select.load_20_switch
      
    action:
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Save - Start automation, wait for the end of automation powercontrol_loads_configuration"
      - wait_template: "{{ state_attr('automation.powercontrol_loads_configuration','current') == 0 }}"
      - service: system_log.write
      
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Automation Configuration - Save - Except(?) input_select in input_text"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_loads
          value: "{{ states('input_select.power_loads') }}"

      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_1
          value: "{{ states('input_select.power_load_1') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_2
          value: "{{ states('input_select.power_load_2') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_3
          value: "{{ states('input_select.power_load_3') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_4
          value: "{{ states('input_select.power_load_4') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_5
          value: "{{ states('input_select.power_load_5') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_6
          value: "{{ states('input_select.power_load_6') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_7
          value: "{{ states('input_select.power_load_7') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_8
          value: "{{ states('input_select.power_load_8') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_9
          value: "{{ states('input_select.power_load_9') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_10
          value: "{{ states('input_select.power_load_10') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_11
          value: "{{ states('input_select.power_load_11') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_12
          value: "{{ states('input_select.power_load_12') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_13
          value: "{{ states('input_select.power_load_13') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_14
          value: "{{ states('input_select.power_load_14') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_15
          value: "{{ states('input_select.power_load_15') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_16
          value: "{{ states('input_select.power_load_16') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_17
          value: "{{ states('input_select.power_load_17') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_18
          value: "{{ states('input_select.power_load_18') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_19
          value: "{{ states('input_select.power_load_19') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.power_load_20
          value: "{{ states('input_select.power_load_20') }}"

      - service: input_text.set_value
        data:
          entity_id: input_text.load_1_switch
          value: "{{ states('input_select.load_1_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_2_switch
          value: "{{ states('input_select.load_2_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_3_switch
          value: "{{ states('input_select.load_3_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_4_switch
          value: "{{ states('input_select.load_4_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_5_switch
          value: "{{ states('input_select.load_5_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_6_switch
          value: "{{ states('input_select.load_6_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_7_switch
          value: "{{ states('input_select.load_7_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_8_switch
          value: "{{ states('input_select.load_8_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_9_switch
          value: "{{ states('input_select.load_9_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_10_switch
          value: "{{ states('input_select.load_10_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_11_switch
          value: "{{ states('input_select.load_11_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_12_switch
          value: "{{ states('input_select.load_12_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_13_switch
          value: "{{ states('input_select.load_13_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_14_switch
          value: "{{ states('input_select.load_14_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_15_switch
          value: "{{ states('input_select.load_15_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_16_switch
          value: "{{ states('input_select.load_16_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_17_switch
          value: "{{ states('input_select.load_17_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_18_switch
          value: "{{ states('input_select.load_18_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_19_switch
          value: "{{ states('input_select.load_19_switch') }}"
      - service: input_text.set_value
        data:
          entity_id: input_text.load_20_switch
          value: "{{ states('input_select.load_20_switch') }}"

      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: "Configuration Automation - Save - End of Save"


# Automation that is triggered when the power used exceeds the maximum power set.
# It acts after TOT seconds from exceeding the limit, starts the posting script and sends intervention notification.
# Repeats the detachment script until the committed power is within the limit.
  - id: 'powercontrol_stop_loads'
    alias: PowerControl - Stop Loads
    description: ''
    trigger:
    - platform: template
      value_template: "{{ states(states('input_text.power_loads')) |int(default=0) > states('sensor.immediate_maximum_power')|int(default=0) }}"
      for: 
        seconds: "{{ states('input_number.immediate_stop_pace')|int(default=0) }}"
      id: immediate
    - platform: template
      value_template: "{{ states(states('input_text.power_loads')) |int(default=0) > states('sensor.delayed_maximum_power')|int(default=0) }}"
      for: 
        minutes: "{{ states('input_number.delayed_stop_pace')|int(default=0) }}"
      id: delayed
    condition:
    - condition: state
      entity_id: input_boolean.active_power_control
      state: 'on'
    action:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Triggered Stop Load Automation: Power Loads ({{ states(states('input_text.power_loads'))|int(default=0) }}))"
    - choose:
      - conditions:
          - condition: trigger
            id: immediate
        sequence:
          - service: input_boolean.turn_on
            target: 
              entity_id: input_boolean.trigger_sensor
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Load Automation Stop triggered: Trigger Type Immediate"
      - conditions:
          - condition: trigger
            id: delayed
        sequence:
          - service: input_boolean.turn_off
            target: 
              entity_id: input_boolean.trigger_sensor
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Load Automation Stop triggered: Trigger Type Delayed"
        
    - repeat:
        sequence:
          - service: system_log.write
            data_template:
              level: debug
              logger: homeassistant.components.pc
              message: "Started script stop loads: power loads {{ states(states('input_text.power_loads'))|int(default=0)}}"
          - service: script.turn_on
            data: {}
            entity_id: script.stop_loads_general
        until:
          - condition: template
            value_template: >
              {{
              ((states(states('input_text.power_loads'))|int(default=0) > states('sensor.delayed_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "off") or
              ((states(states('input_text.power_loads'))|int(default=0) > states('sensor.immediate_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "on") 
              }}
    - service: input_boolean.turn_off
      target: 
        entity_id: input_boolean.trigger_sensor
    mode: single

# If for TOT minutes the power limit is respected, start the load reactivation script until the "suspended" power is zero.
  - id: 'powercontrol_loads_start'
    alias: PowerControl - Loads Start
    description: ''
    trigger:
    - platform: template
      value_template: "{{ ((states(states('input_text.power_loads'))|int(default=0) + states('sensor.suspended_loads')|int(default=0)) < states('sensor.delayed_maximum_power')|int(default=0)) and (states('sensor.suspended_loads')|int(default=0) > 0) }}"
      for:
        minutes: "{{ states('input_number.restart_delay')|int(default=0) }}"
    condition:
    - condition: state
      entity_id: input_boolean.active_power_control
      state: 'on'
    - condition: template
      value_template: "{{ states('sensor.suspended_loads')|int(default=0) > 0 }}"
    action:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Triggered load start automation: Suspended Power Loads ({{ states(states('input_text.power_loads'))|int(default=0) + states('sensor.suspended_loads')|int(default=0)}}) < Maximum Power ({{states('sensor.delayed_maximum_power')|int(default=0) }}) "
    - repeat:
        until:
        - condition: template
          value_template: "{{ states('sensor.suspended_loads')|int(default=0) > 0 }}"
        sequence:
        - service: system_log.write
          data_template:
            level: debug
            logger: homeassistant.components.pc
            message: "Start script start loads: suspended ({{ states('sensor.suspended_loads')|int(default=0) }})>0 "
        - service: script.turn_on
          data: {}
          entity_id: script.start_loads_general
    mode: single

# Checks if a load is turned back on manually, i.e. if its switch is activated by the user,
# and resets its suspended power.
  - id: 'powercontrol_watchdog_suspended'
    alias: PowerControl - Check on manual reactivation
    description: >-
      Monitor load switches and, if one of them is active but its power
       Suspended is different from 0, the door to zero.
    trigger:
      - platform: template
        value_template: >
              {{
              ( states(states('input_text.load_1_switch')) == 'on' and states('input_number.suspended_load_1')|int(default=0) > 0 ) or
              ( states(states('input_text.load_2_switch')) == 'on' and states('input_number.suspended_load_2')|int(default=0) > 0 ) or
              ( states(states('input_text.load_3_switch')) == 'on' and states('input_number.suspended_load_3')|int(default=0) > 0 ) or
              ( states(states('input_text.load_4_switch')) == 'on' and states('input_number.suspended_load_4')|int(default=0) > 0 ) or
              ( states(states('input_text.load_5_switch')) == 'on' and states('input_number.suspended_load_5')|int(default=0) > 0 ) or
              ( states(states('input_text.load_6_switch')) == 'on' and states('input_number.suspended_load_6')|int(default=0) > 0 ) or
              ( states(states('input_text.load_7_switch')) == 'on' and states('input_number.suspended_load_7')|int(default=0) > 0 ) or
              ( states(states('input_text.load_8_switch')) == 'on' and states('input_number.suspended_load_8')|int(default=0) > 0 ) or
              ( states(states('input_text.load_9_switch')) == 'on' and states('input_number.suspended_load_9')|int(default=0) > 0 ) or
              ( states(states('input_text.load_10_switch')) == 'on' and states('input_number.suspended_load_10')|int(default=0) > 0 ) or
              ( states(states('input_text.load_11_switch')) == 'on' and states('input_number.suspended_load_11')|int(default=0) > 0 ) or
              ( states(states('input_text.load_12_switch')) == 'on' and states('input_number.suspended_load_12')|int(default=0) > 0 ) or
              ( states(states('input_text.load_13_switch')) == 'on' and states('input_number.suspended_load_13')|int(default=0) > 0 ) or
              ( states(states('input_text.load_14_switch')) == 'on' and states('input_number.suspended_load_14')|int(default=0) > 0 ) or
              ( states(states('input_text.load_15_switch')) == 'on' and states('input_number.suspended_load_15')|int(default=0) > 0 ) or
              ( states(states('input_text.load_16_switch')) == 'on' and states('input_number.suspended_load_16')|int(default=0) > 0 ) or
              ( states(states('input_text.load_17_switch')) == 'on' and states('input_number.suspended_load_17')|int(default=0) > 0 ) or
              ( states(states('input_text.load_18_switch')) == 'on' and states('input_number.suspended_load_18')|int(default=0) > 0 ) or
              ( states(states('input_text.load_19_switch')) == 'on' and states('input_number.suspended_load_19')|int(default=0) > 0 ) or
              ( states(states('input_text.load_20_switch')) == 'on' and states('input_number.suspended_load_20')|int(default=0) > 0 )
              }}
        for:
          seconds: 5
    condition: []
    action:
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: Automation Check Manual reactivation - Start
      - service: input_number.set_value
        data_template:
          value: 0
          entity_id: "{% if states(states('input_text.load_1_switch')) == 'on' and states('input_number.suspended_load_1')|int(default=0) > 0 %}input_number.suspended_load_1
          {% elif states(states('input_text.load_2_switch')) == 'on' and states('input_number.suspended_load_2')|int(default=0) > 0 %}input_number.suspended_load_2
          {% elif states(states('input_text.load_3_switch')) == 'on' and states('input_number.suspended_load_3')|int(default=0) > 0 %}input_number.suspended_load_3
          {% elif states(states('input_text.load_4_switch')) == 'on' and states('input_number.suspended_load_4')|int(default=0) > 0 %}input_number.suspended_load_4
          {% elif states(states('input_text.load_5_switch')) == 'on' and states('input_number.suspended_load_5')|int(default=0) > 0 %}input_number.suspended_load_5
          {% elif states(states('input_text.load_6_switch')) == 'on' and states('input_number.suspended_load_6')|int(default=0) > 0 %}input_number.suspended_load_6
          {% elif states(states('input_text.load_7_switch')) == 'on' and states('input_number.suspended_load_7')|int(default=0) > 0 %}input_number.suspended_load_7
          {% elif states(states('input_text.load_8_switch')) == 'on' and states('input_number.suspended_load_8')|int(default=0) > 0 %}input_number.suspended_load_8
          {% elif states(states('input_text.load_9_switch')) == 'on' and states('input_number.suspended_load_9')|int(default=0) > 0 %}input_number.suspended_load_9
          {% elif states(states('input_text.load_10_switch')) == 'on' and states('input_number.suspended_load_10')|int(default=0) > 0 %}input_number.suspended_load_10
          {% elif states(states('input_text.load_11_switch')) == 'on' and states('input_number.suspended_load_11')|int(default=0) > 0 %}input_number.suspended_load_11
          {% elif states(states('input_text.load_12_switch')) == 'on' and states('input_number.suspended_load_12')|int(default=0) > 0 %}input_number.suspended_load_12
          {% elif states(states('input_text.load_13_switch')) == 'on' and states('input_number.suspended_load_13')|int(default=0) > 0 %}input_number.suspended_load_13
          {% elif states(states('input_text.load_14_switch')) == 'on' and states('input_number.suspended_load_14')|int(default=0) > 0 %}input_number.suspended_load_14
          {% elif states(states('input_text.load_15_switch')) == 'on' and states('input_number.suspended_load_15')|int(default=0) > 0 %}input_number.suspended_load_15
          {% elif states(states('input_text.load_16_switch')) == 'on' and states('input_number.suspended_load_16')|int(default=0) > 0 %}input_number.suspended_load_16
          {% elif states(states('input_text.load_17_switch')) == 'on' and states('input_number.suspended_load_17')|int(default=0) > 0 %}input_number.suspended_load_17
          {% elif states(states('input_text.load_18_switch')) == 'on' and states('input_number.suspended_load_18')|int(default=0) > 0 %}input_number.suspended_load_18
          {% elif states(states('input_text.load_19_switch')) == 'on' and states('input_number.suspended_load_19')|int(default=0) > 0 %}input_number.suspended_load_11
          {% elif states(states('input_text.load_20_switch')) == 'on' and states('input_number.suspended_load_20')|int(default=0) > 0 %}input_number.suspended_load_20
          {% else %}none
          {% endif %}"
      - service: system_log.write
        data_template:
          level: debug
          logger: homeassistant.components.pc
          message: Automation Check Manual reactivation - End
    mode: single
    
    
#################################################################
######################### SCRIPT  ###############################
#################################################################

script:

# Loads are deactivated in reverse numerical order (lowest priority to highest).
# Wait for one script to be completely completed before moving on to the next.
  stop_loads_general:
    alias: PowerControl - Stop Loads General
    sequence:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 20"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_20')}}"
        switch: "{{states('input_text.load_20_switch')}}"
        suspend: "input_number.suspended_load_20"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 19"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_19')}}"
        switch: "{{states('input_text.load_19_switch')}}"
        suspend: "input_number.suspended_load_19"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 18"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_18')}}"
        switch: "{{states('input_text.load_18_switch')}}"
        suspend: "input_number.suspended_load_18"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 17"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_17')}}"
        switch: "{{states('input_text.load_17_switch')}}"
        suspend: "input_number.suspended_load_17"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 16"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_16')}}"
        switch: "{{states('input_text.load_16_switch')}}"
        suspend: "input_number.suspended_load_16"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 15"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_15')}}"
        switch: "{{states('input_text.load_15_switch')}}"
        suspend: "input_number.suspended_load_15"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 14"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_14')}}"
        switch: "{{states('input_text.load_14_switch')}}"
        suspend: "input_number.suspended_load_14"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 13"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_13')}}"
        switch: "{{states('input_text.load_13_switch')}}"
        suspend: "input_number.suspended_load_13"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 12"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_12')}}"
        switch: "{{states('input_text.load_12_switch')}}"
        suspend: "input_number.suspended_load_12"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 11"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_11')}}"
        switch: "{{states('input_text.load_11_switch')}}"
        suspend: "input_number.suspended_load_11"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 10"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_10')}}"
        switch: "{{states('input_text.load_10_switch')}}"
        suspend: "input_number.suspended_load_10"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 9"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_9')}}"
        switch: "{{states('input_text.load_9_switch')}}"
        suspend: "input_number.suspended_load_9"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 8"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_8')}}"
        switch: "{{states('input_text.load_8_switch')}}"
        suspend: "input_number.suspended_load_8"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 7"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_7')}}"
        switch: "{{states('input_text.load_7_switch')}}"
        suspend: "input_number.suspended_load_7"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 6"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_6')}}"
        switch: "{{states('input_text.load_6_switch')}}"
        suspend: "input_number.suspended_load_6"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 5"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_5')}}"
        switch: "{{states('input_text.load_5_switch')}}"
        suspend: "input_number.suspended_load_5"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 4"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_4')}}"
        switch: "{{states('input_text.load_4_switch')}}"
        suspend: "input_number.suspended_load_4"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 3"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_3')}}"
        switch: "{{states('input_text.load_3_switch')}}"
        suspend: "input_number.suspended_load_3"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 2"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_2')}}"
        switch: "{{states('input_text.load_2_switch')}}"
        suspend: "input_number.suspended_load_2"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script stop load 1"
    - service: script.stop_single_load
      data_template: 
        power: "{{states('input_text.power_load_1')}}"
        switch: "{{states('input_text.load_1_switch')}}"
        suspend: "input_number.suspended_load_1"
    mode: single

# Loads are reactivated in numerical order (from higher priority to lowest priority)
# Wait for one script to be completely completed before moving on to the next.
  start_loads_general:
    alias: PowerControl - Start Loads General
    sequence:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 1"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_1')}}"
        switch: "{{states('input_text.load_1_switch')}}"
        suspend: "input_number.suspended_load_1"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 2"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_2')}}"
        switch: "{{states('input_text.load_2_switch')}}"
        suspend: "input_number.suspended_load_2"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 3"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_3')}}"
        switch: "{{states('input_text.load_3_switch')}}"
        suspend: "input_number.suspended_load_3"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 4"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_4')}}"
        switch: "{{states('input_text.load_4_switch')}}"
        suspend: "input_number.suspended_load_4"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 5"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_5')}}"
        switch: "{{states('input_text.load_5_switch')}}"
        suspend: "input_number.suspended_load_5"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 6"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_6')}}"
        switch: "{{states('input_text.load_6_switch')}}"
        suspend: "input_number.suspended_load_6"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 7"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_7')}}"
        switch: "{{states('input_text.load_7_switch')}}"
        suspend: "input_number.suspended_load_7"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 8"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_8')}}"
        switch: "{{states('input_text.load_8_switch')}}"
        suspend: "input_number.suspended_load_8"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 9"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_9')}}"
        switch: "{{states('input_text.load_9_switch')}}"
        suspend: "input_number.suspended_load_9"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 10"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_10')}}"
        switch: "{{states('input_text.load_10_switch')}}"
        suspend: "input_number.suspended_load_10"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 11"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_11')}}"
        switch: "{{states('input_text.load_11_switch')}}"
        suspend: "input_number.suspended_load_11"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 12"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_12')}}"
        switch: "{{states('input_text.load_12_switch')}}"
        suspend: "input_number.suspended_load_12"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 13"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_13')}}"
        switch: "{{states('input_text.load_13_switch')}}"
        suspend: "input_number.suspended_load_13"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 14"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_14')}}"
        switch: "{{states('input_text.load_14_switch')}}"
        suspend: "input_number.suspended_load_14"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 15"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_15')}}"
        switch: "{{states('input_text.load_15_switch')}}"
        suspend: "input_number.suspended_load_15"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 16"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_16')}}"
        switch: "{{states('input_text.load_16_switch')}}"
        suspend: "input_number.suspended_load_16"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 17"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_17')}}"
        switch: "{{states('input_text.load_17_switch')}}"
        suspend: "input_number.suspended_load_17"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 18"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_18')}}"
        switch: "{{states('input_text.load_18_switch')}}"
        suspend: "input_number.suspended_load_18"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 19"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_19')}}"
        switch: "{{states('input_text.load_19_switch')}}"
        suspend: "input_number.suspended_load_19"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Start script start load 20"
    - service: script.start_single_load
      data_template: 
        power: "{{states('input_text.power_load_20')}}"
        switch: "{{states('input_text.load_20_switch')}}"
        sospesa: "input_number.suspended_load_20"
    mode: single

#################################################################
###################### STOP LOADS #############################
#################################################################

# Start the load detachment.
# Verify that the load is configured as a power sensor and as a switch.
# Check if the maximum power is exceeded, if the load is on (committed power > 10W).
# Save the currently used power in its "suspend" value.
# Turn off the switch upstream of the load and send the notification. Wait for TOT seconds before proceeding with the next load.

  stop_single_load:
    alias: PowerControl - Stop Single Load
    sequence:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Start"
    # Check if the load power sensor is set
    - condition: template
      value_template: "{{ power != 'Selected' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 1 - Ok"
        
    # Check if the load power sensor is available
    - condition: template
      value_template: "{{ states(power) != 'unavailable' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 1.5 - Ok"
        
    # Check if the load switch is set
    - condition: template
      value_template: "{{ switch != 'Selected' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 2 - Ok"

    # Check if the load switch is available
    - condition: template
      value_template: "{{ states(switch) != 'unavailable' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 2.5 - Ok"

    # Check if the power in use is greater than the set limits
    - condition: template
      value_template: >
        {{
        ((states(states('input_text.power_loads'))|int(default=0) > states('sensor.delayed_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "off") or
        ((states(states('input_text.power_loads'))|int(default=0) > states('sensor.immediate_maximum_power')|int(default=0)) and states('input_boolean.trigger_sensor') == "on") 
        }}
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 3 - Ok {{ states(states('input_text.power_load'))|int(default=0)}}W}}"
    # Check if the load is currently in use
    - condition: template
      value_template: "{{ states(power) |int(default=0) > 10 }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 4 - Ok"
    # Except for power in use from the load on its suspended sensor
    - service: input_number.set_value
      data_template:
        value: "{{ states(power) }}"
        entity_id: "{{suspended}}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Shifted load power {{ states(power) }} suspended {{states(suspended)|int(default=0)}} (should be the same)."
    # I turn off the load
    - service_template: switch.turn_off
      data_template:
        entity_id: "{{ switch }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Load Off"
    # Send Notification
    - service: notify.tutti
      data:
        title: Power Limit Exceeded
        message: "{{ state_attr(switch,'friendly_name') }} deactivated."
        data:
          push:
            thread-id: "powercontrol"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Sent notification. We expect {{ states('input_number.pause_between_detachments') }} seconds "
    # We wait before moving on to the next load to be detached.
    - delay: 
        seconds: "{{ states('input_number.pause_between_detachments') }}"
    mode: queued



#################################################################
###################### START LOADS ############################
#################################################################

# Script for reactivating loads.
# Verify that the load is configured as a power sensor and as a switch.
# Check that the load has been turned off (power waiting)
# Check that the power limit is respected.
# Check even if reactivating the load (assuming a consumption equal to what it had at the time of deactivation)
# does not exceed the maximum value.
# This last check is used to prevent a load from being reattached and then reattached after a few seconds because it has
# caused a new overshoot of the limit.
# Set its "suspended" value to zero, turn the switch back on and send a wake-up notification.
# Finally wait TOT minutes before moving on to the next load.

  start_single_load:
    alias: PowerControl - Start Single Load
    sequence:
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Start"
    # Check if the load power sensor has been configured
    - condition: template
      value_template: "{{ power != 'Selected' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Condition 1 ok"
    
    # Check if the load power sensor is available
    - condition: template
      value_template: "{{ states(power) != 'unavailable' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 1.5 - Ok"
        
    # Check if the load switch has been configured
    - condition: template
      value_template: "{{ switch != 'Selected' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Condition 2 ok"
        
    # Check if the load switch is available
    - condition: template
      value_template: "{{ states(switch) != 'unavailable' }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Stop Load {{ state_attr(switch,'friendly_name') }} - Condition 2.5 - Ok"

    # Check if the suspended power of the load is greater than 0 (in this case the load has been turned off by the load account)
    - condition: template
      value_template: "{{ states(suspended)|int(default=0) > 0 }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Condition 3 ok"

    # We verify that the power in use is less than the maximum delayed power.
    - condition: template
      value_template: "{{ states(states('input_text.potenza_carichi'))|int(default=0) < states('sensor.potenza_massima_ritardato')|int(default=0)}}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Condition 4 ok"

    # Check if, by reactivating the load, the power limit is not exceeded again.
    - condition: template
      value_template: "{{ states(states('input_text.power_loads'))|int(default=0) + states(suspended)|int(default=0) < states('sensor.delayed_maximum_power')|int(default=0) }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Condition 5 ok"

    # Set the suspended load power to zero.
    - service: input_number.set_value
      data_template:
        value: 0
        entity_id: "{{sospesa}}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Reset suspended power"
    # We turn on the load
    - service_template: switch.turn_on
      data_template:
        entity_id: "{{ switch }}"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Switch activated"
    # Send notification
    - service: notify.tutti
      data:
        title: Limite potenza rientrato
        message: "{{ state_attr(switch,'friendly_name') }} Reactivated"
        data:
          push:
            thread-id: "powercontrol"
    - service: system_log.write
      data_template:
        level: debug
        logger: homeassistant.components.pc
        message: "Script Start Load {{ state_attr(switch,'friendly_name') }} - Sent notification. We expect {{ states('input_number.restart_delay') }} minutes"
    - delay:
        minutes: "{{ states('input_number.restart_delay') }}"
    mode: queued
